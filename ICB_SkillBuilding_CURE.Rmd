---
title: "CURE_SkillBuilding"
author: "Abby Beatty"
date: "March 15, 2020"
output:
  pdf_document: default
  html_document: default
---

#Read in packages and SE function
```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
#Load all packages necessary for statistical anlaysis and figure creation
library(ggplot2)
library(multcomp)
library(nlme)
library(grid)
library(Rmisc)
library(gridExtra)
library(emmeans)
library(cowplot)

```

#Summary Function
```{r}
#Build summary function to calculate custom combinations of averages, standard deviations, standard errors and confidence intervals
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=TRUE,
                      conf.interval=.95, .drop=TRUE) {
    library(plyr)
    # New version of length which can handle NA's: if na.rm==T, don't count them
    length2 <- function (x, na.rm=TRUE) {
        if (na.rm) sum(!is.na(x))
        else       length(x)
    }
    # This does the summary. For each group's data frame, return a vector with
    # N, mean, and sd
    datac <- ddply(data, groupvars, .drop=.drop,
      .fun = function(xx, col) {
        c(N    = length2(xx[[col]], na.rm=na.rm),
          mean = mean   (xx[[col]], na.rm=na.rm),
          sd   = sd     (xx[[col]], na.rm=na.rm)
        )
      },
      measurevar
    )
    # Rename the "mean" column    
    datac <- rename(datac, c("mean" = measurevar))
    datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean
    # Confidence interval multiplier for standard error
    # Calculate t-statistic for confidence interval: 
    # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
    ciMult <- qt(conf.interval/2 + .5, datac$N-1)
    datac$ci <- datac$se * ciMult
    return(datac)
    }

```

#Load Data
```{r}
#Read in data file 
#This data set contains all data for both the guided and autonomous formats (confidence, applicability, and perceptions of the CURE survey constructs)
model=read.csv("Models.csv")
#Relevel course iterations to display in order of semester implementation, Guided followed by Autonomous
model$Experience=factor(model$Experience, levels=c("Guided", "Autonomous"))
#Relevel time-point to display in order of course survey implementation (pre and the post-course survey timepoints)
model$Time=factor(model$Time, levels=c("Pre", "Post"))
```

##18.19 post data: Confidence Measures 
```{r}
#Subset data to include only measures of student confidence
conf=subset(model, Skill == "Confidence")

#Run linear model for student reported scores (based on Likert-Scale reports) between experiences (guided vs autonomous) by each subskill (survey question)
conf.lm=lm(Score~ Experience*Subskill, data=conf, na.action=na.omit)
#Summary output
anova(conf.lm)
#Run emmeans for pairwise comparisons between guided and autonomous formats for each survey question from the confidence construct
conf.means=emmeans(conf.lm, list(pairwise ~ Experience|Subskill), adjust = "tukey")
#Print results
conf.means

#Plot confidence survey measures based on estimated means pairwise comparisons and adjusted p-values
conf.plot=plot(conf.means, by = "Subskill", comparisons = TRUE, horizontal = FALSE, color="darkgreen", xlab="Confidence")+
  theme_bw() 

conf.plot
```

##18.19 post data: Applicabilty Measures 
```{r}
#Subset data to include only measures of student perceived applicability
app=subset(model, Skill == "Applicability")

#Run linear model for student reported scores (based on Likert-Scale reports) between experiences (guided vs autonomous) by each subskill (survey question)
app.lm=lm(Score~Experience*Subskill, data=app, na.action=na.omit)
#Summary output
anova(app.lm)
#Run emmeans for pairwise comparisons between guided and autonomous formats for each survey question from the applicability construct
app.means=emmeans(app.lm, list(pairwise ~ Experience|Subskill), cov.keep="Year", adjust = "tukey")
#Print results
app.means

#Plot applicability survey measures based on estimated means pairwise comparisons and adjusted p-values
app.plot=plot(app.means, by = "Subskill", comparisons = TRUE, horizontal = FALSE, color="darkgreen", xlab="Applicability") +
  theme_bw() 


app.plot

```

##18.19 post data: CURE Measures 
```{r}
#Subset data to include only measures of student perception of the CURE format
cure=subset(model, Skill == "CURE")

#Run linear model for student reported scores (based on Likert-Scale reports) between experiences (guided vs autonomous) by each subskill (survey question)
cure.lm=lm(Score~Experience*Subskill, data=cure, na.action=na.omit)
#Summary output
anova(cure.lm)
#Run emmeans for pairwise comparisons between guided and autonomous formats for each survey question from the CURE format construct
cure.means=emmeans(cure.lm, list(pairwise ~ Experience|Subskill), adjust = "tukey")
#Print results
cure.means

#Plot CURE format survey measures based on estimated means pairwise comparisons and adjusted p-values
plot(cure.means, by = "Subskill", comparisons = TRUE, horizontal = FALSE, color="darkgreen" )


#subset only significant comparisons for publication plot
cure.sub=subset(cure, Subskill == "Time"| Subskill == "Benefit"| Subskill == "Recommend" | Subskill == "In.engage" |Subskill == "Discovery")

#Sanity Check
#Run linear model for significant student reported scores (based on Likert-Scale reports) between experiences (guided vs autonomous) by each subskill (survey question)
curesub.lm=lm(Score~Experience*Subskill, data=cure.sub, na.action=na.omit)
anova(curesub.lm)
cure.sub.means=emmeans(curesub.lm, list(pairwise ~ Experience|Subskill), adjust = "tukey")
cure.sub.means

#Plot only significant relationships for publication figure 1
cure.plot=plot(cure.sub.means, by = "Subskill", comparisons = TRUE, horizontal = FALSE, color="darkgreen", xlab="Perceptions of the CURE" )+
  theme_bw() 


```
#draw multi panel plot 
```{r}
#Build multi-panel plot for figure 1 of publication 
p=ggdraw() +
  #Applicability comparisons between formats
  draw_plot(app.plot, x = 0, y = 0.66, width = 0.6, height = .28) +
  #Confidence comparisons between formats
  draw_plot(conf.plot, x = 0, y = .33, width = 0.8, height = .28)+
  #Perception of CURE between formats
  draw_plot(cure.plot, x = 0, y = 0.0, width = 1, height = 0.28) +
  #Add panel labels to plot
   draw_plot_label(label = c("C", "B","A"), size = 15,
                  x = c(0, 0 ,0), y = c(0.33, 0.66,0.99)) 
  
#Add white space margin to figure 
p2= p + theme(plot.margin=unit(c(15,15,15,15),"mm")) 

#Save as high quality png file
ggsave(p2, file="multipanel.png", width=10, height=12, dpi=600)

p2
```

##Pre and Post-Course Survey Comparisons: Confidence Measures 
#Guided Format
```{r}
#Pre and post comparison in guided format
#Subset data to isolate responses from the guided format
conf.18=subset(conf, Experience == "Guided")
#Remove "Abiity to identify weaknesses" question, as it was only asked in the post-course survey
conf.18=subset(conf.18, Subskill != "Weakness")

#run linear model to compare pre and post-course student reports of confidence
conf.18pp=lme(Score~as.factor(Time)*Subskill, random= ~1|ID, data=conf.18, na.action=na.omit)
#Summary output
anova(conf.18pp)

#Run emmeans for pairwise comparisons between pre and post-course responses for each survey question from the confidence construct in the guided format
confmeans18=emmeans(conf.18pp, list(pairwise ~ Time|Subskill), adjust = "tukey")
confmeans18

##Plot confidence survey measures based on estimated means pairwise comparisons and adjusted p-values
plot(confmeans18, by = "Subskill", comparisons = TRUE, horizontal = FALSE, color="darkgreen" )
```

#Autonomous Format
```{r}
#Repeat all analyses for pre and post comparison in autonomous format
conf.19=subset(conf, Experience == "Autonomous")
conf.19=subset(conf.19, Subskill != "Weakness")
conf.19pp=lme(Score~as.factor(Time)*Subskill, random= ~1|ID, data=conf.19, na.action=na.omit)
anova(conf.19pp)
confmeans19=emmeans(conf.19pp, list(pairwise ~ Time|Subskill), adjust = "tukey")
confmeans19
plot(confmeans19, by = "Subskill", comparisons = TRUE, horizontal = FALSE, color="darkgreen" )
```

##Pre and Post-Course Survey Comparisons: Applicability Measures 
#Guided Format
```{r}
#Pre and post comparison in guided format
#Subset data to isolate responses from the guided format
app.18=subset(app, Experience == "Guided")
#Remove "Abiity to identify weaknesses" question, as it was only asked in the post-course survey
app.18=subset(app.18, Subskill != "Weakness")

#run linear model to compare pre and post-course student reports of applicability
app.18pp=lme(Score~Time*Subskill, random= ~1|ID, data=app.18, na.action=na.omit)
#Summary report
anova(app.18pp)

#Run emmeans for pairwise comparisons between pre and post-course responses for each survey question from the applicability construct in the guided format
appmeans18=emmeans(app.18pp, list(pairwise ~ Time|Subskill), adjust = "tukey")
appmeans18
##Plot applicability survey measures based on estimated means pairwise comparisons and adjusted p-values
plot(appmeans18, by = "Subskill", comparisons = TRUE, horizontal = FALSE, color="darkgreen" )
```

#Autonomous Format
```{r}
#Repeat all analyses for pre and post comparison in autonomous format
#Pre and post comparison in autonomous
app.19=subset(app, Experience == "Autonomous")
app.19=subset(app.19, Subskill != "Weakness")
app.19pp=lme(Score~Time*Subskill, random= ~1|ID, data=app.19, na.action=na.omit)
anova(app.19pp)
appmeans19=emmeans(app.19pp, list(pairwise ~ Time|Subskill), adjust = "tukey")
appmeans19
plot(appmeans19, by = "Subskill", comparisons = TRUE, horizontal = FALSE, color="darkgreen" ) 
```

#Pre and Post-Course Survey Comparisons
#Guided and Autonomous Formats Co-Analyzed
```{r}
#Run linear model to compare pre and post-course student reports of applicability
app.pp=lme(Score~Time*Subskill, random= ~1|ID, data=app, na.action=na.omit)
#Summary report
anova(app.pp)
#Run emmeans for pairwise comparisons between pre and post-course responses for each survey question from the applicability construct
appmeans=emmeans(app.pp, list(pairwise ~ Time|Subskill), adjust = "tukey")
appmeans
##Plot applicability survey measures based on estimated means pairwise comparisons and adjusted p-values
plot(appmeans, by = "Subskill", comparisons = TRUE, horizontal = FALSE, color="darkgreen" ) 

#subset data to include both guided and autonomous formats, removing "Abiity to Identify Weaknesses" question, which was only asked on the post-course survey
conf.w=subset(conf, Subskill != "Weakness")
#Run linear model to compare pre and post-course student reports of confidence
con.pp=lme(Score~Time*Subskill, random= ~1|ID, data=conf.w, na.action=na.omit)
#Summary Report
anova(con.pp)
#Run emmeans for pairwise comparisons between pre and post-course responses for each survey question from the confidence construct
conmeans=emmeans(con.pp, list(pairwise ~ Time|Subskill), adjust = "tukey")
conmeans
##Plot confidence survey measures based on estimated means pairwise comparisons and adjusted p-values
plot(conmeans, by = "Subskill", comparisons = TRUE, horizontal = FALSE, color="darkgreen" ) 

```

#Plot of pre-post comparison
```{r}
#See survey for each survey question asked for comparison between pre- and post-course surveys
#Plot each individual survey question below comparing pre- and post-course responses

#Confidence Construct
des=subset(conf, Subskill == "Design")
des.lm=lme(Score~Time*Experience, random= ~1|ID, data=des, na.action=na.omit)
des.means=emmeans(des.lm, list(pairwise ~ Time|Experience), adjust = "tukey")
des.pl=plot(des.means, by = "Experience", comparisons = TRUE, horizontal = FALSE, color="darkgreen" ) 
des.pl

per=subset(conf, Subskill == "Perform")
per.lm=lme(Score~Time*Experience, random= ~1|ID, data=per, na.action=na.omit)
per.means=emmeans(per.lm, list(pairwise ~ Time|Experience), adjust = "tukey")
per.pl=plot(per.means, by = "Experience", comparisons = TRUE, horizontal = FALSE, color="darkgreen" ) 
per.pl

nb=subset(conf, Subskill == "Notebook")
nb.lm=lme(Score~Time*Experience, random= ~1|ID, data=nb, na.action=na.omit)
nb.means=emmeans(nb.lm, list(pairwise ~ Time|Experience), adjust = "tukey")
nb.pl=plot(nb.means, by = "Experience", comparisons = TRUE, horizontal = FALSE, color="darkgreen" ) 
nb.pl

#Applicability Construct
dis=subset(app, Subskill == "Discovery")
dis.lm=lme(Score~Time*Experience, random= ~1|ID, data=dis, na.action=na.omit)
dis.means=emmeans(dis.lm, list(pairwise ~ Time|Experience), adjust = "tukey")
dis.pl=plot(dis.means, by = "Experience", comparisons = TRUE, horizontal = FALSE, color="darkgreen" ) 
dis.pl

sk=subset(app, Subskill == "Skills")
sk.lm=lme(Score~Time*Experience, random= ~1|ID, data=sk, na.action=na.omit)
sk.means=emmeans(sk.lm, list(pairwise ~ Time|Experience), adjust = "tukey")
sk.pl=plot(sk.means, by = "Experience", comparisons = TRUE, horizontal = FALSE, color="darkgreen" ) 
sk.pl

ed=subset(app, Subskill == "Everyday")
ed.lm=lme(Score~Time*Experience, random= ~1|ID, data=ed, na.action=na.omit)
ed.means=emmeans(ed.lm, list(pairwise ~ Time|Experience), adjust = "tukey")
ed.pl=plot(ed.means, by = "Experience", comparisons = TRUE, horizontal = FALSE, color="darkgreen" ) 
ed.pl

#Draw multipanel plot of pre vs post-course survey responses
#p3=ggdraw() +
  #draw_plot(ed.pl, x = 0.66, y = 0.5, width = 0.33, height = .4) +
  #draw_plot(sk.pl, x = 0.33, y = 0.5, width = 0.33, height = .4) +
  #draw_plot(dis.pl, x = 0, y = 0.5, width = 0.33, height = .4) +
  #draw_plot(nb.pl, x = 0.66, y = 0, width = 0.33, height = .4)+
  #draw_plot(des.pl, x = 0.33, y = 0, width = 0.33, height = 0.4) +
  #draw_plot(per.pl, x = 0, y = 0, width = 0.33, height = 0.4) +
  #Add white space margin around plot
  #theme(plot.margin=unit(c(15,15,15,15),"mm")) 

#Print plot as high quality publication image
#ggsave(p3, file="pre.post.panel.png", width=12, height=8, dpi=600)

#p3

```



